name: Playwright Tests

on:
  push:
    branches: [ main, master, feature/allure_timestamped_runs ]
  pull_request:
    branches: [ main, master, feature/allure_timestamped_runs ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      APP_URL: https://practice.expandtesting.com/notes/app
      API_URL: https://practice.expandtesting.com/notes/api
      ENV: local
      # Admin credentials for admin-specific tests (configure in GitHub â†’ Settings â†’ Secrets â†’ Actions)
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      # Shared run ID for timestamped allure results (set in first step)
      ALLURE_RUN_ID: run-${{ github.run_number }}-${{ github.run_attempt }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Generate .env for Playwright
        working-directory: e2e
        run: |
          cat << EOF > .env
          APP_URL=${APP_URL}
          API_URL=${API_URL}
          ENV=${ENV}
          ADMIN_EMAIL=${ADMIN_EMAIL}
          ADMIN_PASSWORD=${ADMIN_PASSWORD}
          BUILD_NUMBER=${{ github.run_number }}
          GITHUB_SHA=${{ github.sha }}
          EOF
          echo "ðŸ“‹ Initial .env created (EMAIL/PASSWORD will be set by globalSetup after registration)"

      - name: Install dependencies
        working-directory: e2e
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: e2e
        run: npx playwright install --with-deps

      # Playwright's globalSetup will:
      # 1. Register a new user with Faker-generated credentials
      # 2. Update .env with the new EMAIL and PASSWORD
      # 3. Login and save storage state
      # This ensures each CI run uses a fresh, isolated user
      - name: Run Playwright tests (with Allure)
        working-directory: e2e
        run: npx playwright test
        continue-on-error: true

      # ðŸ” DEBUG: make sure allure-results actually has data
      - name: Debug allure-results content
        if: always()
        working-directory: e2e
        run: |
          echo "=== ALLURE_RUN_ID: $ALLURE_RUN_ID ==="
          echo "=== allure-results structure ==="
          ls -la allure-results/ || echo "NO allure-results DIR"
          ls -la allure-results/$ALLURE_RUN_ID/ 2>/dev/null || echo "No timestamped run folder yet"

      - name: Generate Allure HTML report
        if: always()
        working-directory: e2e
        run: |
          npm install -g allure-commandline
          # Find the latest run folder and generate report from it
          RESULTS_DIR="allure-results/$ALLURE_RUN_ID"
          if [ -d "$RESULTS_DIR" ]; then
            allure generate "$RESULTS_DIR" --clean -o allure-report
          else
            echo "No results in $RESULTS_DIR, checking for any results..."
            allure generate allure-results --clean -o allure-report || echo "No allure results to generate"
          fi

      - name: Upload Allure HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: e2e/allure-report

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ”¬ Schemathesis API Testing
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Schemathesis dependencies
        working-directory: e2e/schemathesis
        run: pip install -r requirements.txt

      # Schemathesis reads from .env which now contains the dynamically
      # registered user's credentials (set by Playwright's globalSetup)
      - name: Run Schemathesis API tests
        working-directory: e2e/schemathesis
        run: python run_schemathesis.py
        continue-on-error: true

      - name: Generate Schemathesis Allure HTML report
        if: always()
        run: |
          # Find the latest run folder and generate report from it
          RESULTS_DIR="e2e/schemathesis/allure-results/$ALLURE_RUN_ID"
          if [ -d "$RESULTS_DIR" ]; then
            allure generate "$RESULTS_DIR" --clean -o e2e/schemathesis/allure-report
          else
            echo "No results in $RESULTS_DIR, checking for any results..."
            allure generate e2e/schemathesis/allure-results --clean -o e2e/schemathesis/allure-report || echo "No Schemathesis results to generate"
          fi

      - name: Upload Schemathesis Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schemathesis-allure-report
          path: e2e/schemathesis/allure-report

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ðŸ“Š Summary
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Generate Playwright Summary
        if: always()
        working-directory: e2e
        run: |
          python scripts/summarize_playwright_results.py \
            --ci \
            --results allure-results \
            >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Could not generate Playwright summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate Schemathesis Summary
        if: always()
        working-directory: e2e
        run: |
          python scripts/summarize_schemathesis_results.py \
            --ci \
            --results schemathesis/allure-results \
            --openapi openapi.json \
            >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Could not generate Schemathesis summary" >> $GITHUB_STEP_SUMMARY

      - name: Add Allure Report link to summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| Report | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **allure-report** | Playwright E2E test results |" >> $GITHUB_STEP_SUMMARY
          echo "| **schemathesis-allure-report** | Schemathesis API fuzz test results |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to View Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from the *Artifacts* section of this run." >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the archive locally." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option A â€“ Open directly (may be limited)" >> $GITHUB_STEP_SUMMARY
          echo "- Double-click \`index.html\`. If the report looks empty, use Option B or C below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option B â€“ Serve with a simple HTTP server" >> $GITHUB_STEP_SUMMARY
          echo "- In a terminal, go to the extracted folder: \`cd /path/to/report-folder\`" >> $GITHUB_STEP_SUMMARY
          echo "- Run: \`npx http-server .\` or \`python -m http.server 8000\`" >> $GITHUB_STEP_SUMMARY
          echo "- Open the shown URL in your browser (for example, http://localhost:8080)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Option C â€“ Use Allure CLI (recommended)" >> $GITHUB_STEP_SUMMARY
          echo "- Install Allure CLI (once): \`npm install -g allure-commandline\`" >> $GITHUB_STEP_SUMMARY
          echo "- In a terminal: \`allure open /path/to/report-folder\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

